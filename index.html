<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>EduMorph — Class 9-10 • India + US</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&display=swap');

    :root{
      --bg:#050814;
      --panel:#0b1224;
      --panel-2:#0a0f1e;
      --border:rgba(255,255,255,0.08);
      --muted:#9aa4b2;
      --text:#f8fafc;
      --accent:#34d399;
      --accent2:#60a5fa;
      --glow:rgba(96,165,250,0.15);
      --glow2:rgba(52,211,153,0.14);
      --r-lg:22px;
      --r-md:14px;
      --shadow:0 12px 40px rgba(0,0,0,0.45);
    }

    *{box-sizing:border-box}
    body{
      font-family:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(96,165,250,0.10), transparent 40%),
        radial-gradient(1200px 800px at 90% 20%, rgba(52,211,153,0.10), transparent 40%),
        radial-gradient(900px 700px at 50% 90%, rgba(168,85,247,0.06), transparent 45%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    /* Glass */
    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02));
      border:1px solid var(--border);
      border-radius: var(--r-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
    }
    .glass-soft{
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.015));
      border:1px solid var(--border);
      border-radius: var(--r-md);
    }

    /* Grad text */
    .grad-text{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Buttons */
    .btn{
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 800;
      letter-spacing: 0.02em;
      transition: transform .12s ease, filter .2s ease, border-color .2s ease, background .2s ease, box-shadow .2s ease;
      transform-origin:center;
      user-select:none;
    }
    .btn:active{ transform: scale(0.98); }
    .btn-primary{
      color:#020617;
      background: linear-gradient(120deg, var(--accent), #7cf8d1, var(--accent2));
      box-shadow: 0 10px 30px var(--glow2), inset 0 1px 0 rgba(255,255,255,0.35);
    }
    .btn-primary:hover{
      filter: brightness(1.06);
      transform: translateY(-1px) scale(1.01);
    }
    .btn-ghost{
      background: rgba(255,255,255,0.04);
      border:1px solid var(--border);
      color: var(--text);
    }
    .btn-ghost:hover{
      border-color: rgba(96,165,250,0.45);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.08);
      transform: translateY(-1px);
    }

    /* Chips */
    .chip{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .04em;
      transition: .18s ease;
    }
    .chip:hover{ border-color: rgba(255,255,255,0.18); transform: translateY(-1px); }
    .chip-active{
      border-color: rgba(52,211,153,0.6);
      background: rgba(52,211,153,0.14);
      color: #ecfff8;
      box-shadow: 0 0 0 4px rgba(52,211,153,0.08);
    }

    /* Tabs */
    .tab{
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .06em;
      transition: .18s ease;
    }
    .tab:hover{ transform: translateY(-1px); }
    .tab-active{
      border-color: rgba(96,165,250,0.6);
      background: rgba(96,165,250,0.14);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.08);
    }

    /* Mode pills */
    .mode{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 900;
      font-size: 11px;
      letter-spacing: .08em;
      transition:.18s ease;
    }
    .mode:hover{ transform: translateY(-1px); }
    .mode-active{
      border-color: rgba(52,211,153,0.6);
      background: rgba(52,211,153,0.12);
      box-shadow: 0 0 0 4px rgba(52,211,153,0.08);
    }

    /* Animations */
    .page-enter{
      animation: pageEnter .35s cubic-bezier(.2,.9,.2,1);
    }
    @keyframes pageEnter{
      from{ opacity:0; transform: translateY(10px) scale(.99); filter: blur(6px); }
      to{ opacity:1; transform: translateY(0) scale(1); filter: blur(0); }
    }

    .pop{
      animation: pop .22s cubic-bezier(.2,1.2,.2,1);
    }
    @keyframes pop{
      0%{ transform: scale(.96); opacity:.5; }
      100%{ transform: scale(1); opacity:1; }
    }

    .floaty{
      animation: floaty 5.5s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(-8px); }
    }

    .floaty2{
      animation: floaty2 7s ease-in-out infinite;
    }
    @keyframes floaty2{
      0%,100%{ transform: translateY(0) translateX(0); }
      50%{ transform: translateY(-10px) translateX(6px); }
    }

    .glow-ring{
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.03),
        0 0 24px var(--glow),
        inset 0 1px 0 rgba(255,255,255,0.06);
    }

    /* Mermaid container polish */
    .diagram-wrap{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      overflow: auto;
    }
    .mermaid{
      background: transparent !important;
    }

    /* Inputs */
    .input{
      background: rgba(255,255,255,0.03);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      outline: none;
      width: 100%;
      transition: .2s ease;
    }
    .input:focus{
      border-color: rgba(96,165,250,0.5);
      box-shadow: 0 0 0 4px rgba(96,165,250,0.12);
    }

    /* Scrollbar */
    ::-webkit-scrollbar{ width: 8px; height: 8px; }
    ::-webkit-scrollbar-track{ background: rgba(255,255,255,0.02); }
    ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.12); border-radius: 999px; }
  </style>
</head>

<body class="min-h-screen">

  <!-- Top Bar -->
  <div class="fixed top-0 left-0 right-0 z-50">
    <div class="max-w-7xl mx-auto px-4 md:px-10 py-4">
      <div class="glass px-4 md:px-6 py-3 flex items-center justify-between">
        <div class="flex items-center gap-3 cursor-pointer" onclick="resetApp()">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-emerald-400 to-blue-500 flex items-center justify-center text-slate-950 font-black glow-ring">E</div>
          <div>
            <div class="text-lg md:text-xl font-extrabold tracking-tight">
              Edu<span class="grad-text">Morph</span>
            </div>
            <div class="text-[10px] tracking-widest uppercase text-slate-400">
              Class 9-10 • India + US
            </div>
          </div>
        </div>
        <div id="badge" class="hidden chip"></div>
      </div>
    </div>
  </div>

  <main id="app" class="pt-28 pb-14 px-4 md:px-10 max-w-7xl mx-auto"></main>

<script>
  mermaid.initialize({ startOnLoad: false, theme: "dark", securityLevel: "loose" });

  /* ========= DATA (starter pack) ========= */
  const TOPIC_LIBRARY = [
    {
      id:"force-laws",
      title:"Force and Laws of Motion",
      subject:"SCIENCE",
      strand:"Physics",
      grades:[9],
      tags:["Newton","Inertia","F=ma","Momentum"],
      visuals:{ mermaid:`
        graph TD
        A[Force] --> B[Changes motion]
        B --> C[Acceleration]
        C --> D[F = m * a]
        A --> E[Newton's Laws]
        E --> E1[1st: Inertia]
        E --> E2[2nd: F=ma]
        E --> E3[3rd: Action-Reaction]
      `},
      content:{
        INDIA:{
          CBSE:{
            learning:[
              "Force is a push/pull that can change state of motion.",
              "Newton’s First Law explains inertia.",
              "Newton’s Second Law: F = m × a.",
              "Newton’s Third Law: action-reaction pairs act on different bodies.",
              "Momentum changes when force acts for time."
            ],
            easy:[
              "Force changes motion.",
              "More mass needs more force.",
              "F = m × a is the main formula."
            ],
            hard:[
              "Connect F=ma with momentum change ideas.",
              "Explain multi-law real-life cases.",
              "Solve mixed numericals."
            ],
            exam:[
              "State Newton’s three laws with examples.",
              "A 5 kg object accelerates at 2 m/s². Find force.",
              "Why does a gun recoil?"
            ],
            finals:[
              "Mixed 5-mark: inertia + applications.",
              "Numerical set combining F=ma and momentum."
            ]
          },
          ICSE:{
            learning:[
              "Force causes acceleration or changes direction.",
              "Inertia is proportional to mass.",
              "F = m × a quantifies motion change.",
              "Action-reaction forces act on different bodies."
            ],
            easy:["More mass = more inertia.","Force makes motion change."],
            hard:["Use precise definitions and units.","Link laws to momentum reasoning."],
            exam:["Define inertia and its types.","Short derivation idea of F=ma."],
            finals:["Structured 5-mark + one numerical."]
          }
        },
        US:{
          COMMON_CORE:{
            learning:[
              "Net force determines acceleration.",
              "Mass measures resistance to acceleration.",
              "Action-reaction forces are equal but act on different objects."
            ],
            easy:["Balanced forces mean no change in motion.","More mass needs more net force."],
            hard:["Analyze simple free-body scenarios.","Explain why action-reaction don't cancel."],
            exam:["Explain net force vs acceleration.","Justify motion with a diagram."],
            finals:["Short conceptual + one numerical."]
          },
          NGSS:{
            learning:[
              "Motion changes when a net force acts.",
              "Models like diagrams support evidence-based explanations."
            ],
            easy:["If forces balance, motion doesn't change."],
            hard:["Claim-evidence-reasoning using diagrams."],
            exam:["Construct explanation with a model."],
            finals:["CER response."]
          }
        }
      },
      quizPool:[
        {q:"Newton's First Law is about:", options:["Acceleration","Inertia","Momentum","Gravity"], correct:1},
        {q:"If mass increases and force stays same, acceleration:", options:["Increases","Decreases","Stays same","Becomes infinite"], correct:1},
        {q:"Unit of force:", options:["Joule","Newton","Watt","Pascal"], correct:1},
        {q:"Action-reaction forces act on:", options:["Same body","Different bodies","Only moving bodies","Only stationary bodies"], correct:1}
      ]
    },

    {
      id:"work-energy",
      title:"Work, Energy and Power",
      subject:"SCIENCE",
      strand:"Physics",
      grades:[9],
      tags:["W=Fs","K.E.","P.E.","Power"],
      visuals:{ mermaid:`
        graph LR
        A[Force] --> B[Displacement]
        B --> C[Work]
        C --> D[Energy]
        D --> E[Kinetic]
        D --> F[Potential]
        C --> G[Power = Work/Time]
      `},
      content:{
        INDIA:{
          CBSE:{
            learning:[
              "Work is done when force causes displacement in its direction.",
              "W = F × s (same direction).",
              "Energy is the capacity to do work.",
              "Kinetic energy is due to motion; potential energy due to position.",
              "Power is rate of doing work: P = W/t."
            ],
            easy:["No displacement = zero work.","Work is measured in Joules.","Power tells speed of work."],
            hard:["Compare energy types with examples.","Solve multi-step numericals."],
            exam:["Define work and power with units.","A 20 N force moves 3 m. Find work.","Differentiate K.E. and P.E."],
            finals:["Case-based numerical + 5-mark conceptual."]
          },
          ICSE:{
            learning:["Work needs force and displacement.","Energy transforms between forms.","Power depends on time."],
            easy:["W = F × s is key."],
            hard:["State conditions for work carefully."],
            exam:["Conditions for work to be done.","Basic W = F × s numerical."],
            finals:["Structured answer set."]
          }
        },
        US:{
          COMMON_CORE:{
            learning:[
              "Work transfers energy when a force moves an object.",
              "Power measures how quickly energy is transferred.",
              "Energy changes form across systems."
            ],
            easy:["More force or distance gives more work."],
            hard:["Analyze energy transfers with losses."],
            exam:["Explain work and power with examples."],
            finals:["Short mixed conceptual set."]
          }
        }
      },
      quizPool:[
        {q:"Work is done when:", options:["Force is applied","Displacement occurs","Mass increases","Object is at rest"], correct:1},
        {q:"SI unit of work:", options:["Watt","Newton","Joule","Pascal"], correct:2},
        {q:"Power equals:", options:["W×t","W/t","F×m","m/a"], correct:1}
      ]
    },

    {
      id:"linear-equations",
      title:"Linear Equations in Two Variables",
      subject:"MATH",
      strand:"Algebra",
      grades:[9],
      tags:["Pairs","Graph","Infinite solutions"],
      visuals:{ mermaid:`
        graph TD
        A[ax + by + c = 0] --> B[Infinite solutions]
        B --> C[Ordered pairs]
        C --> D[Plot points]
        D --> E[Straight line]
      `},
      content:{
        INDIA:{
          CBSE:{
            learning:[
              "Linear equations in two variables have form ax + by + c = 0.",
              "They have infinitely many solutions.",
              "Solutions are ordered pairs (x, y).",
              "Graph of such equation is a straight line.",
              "Tables help generate points."
            ],
            easy:["Pick x, find y.","Graph is a straight line."],
            hard:["Interpret intercepts informally.","Translate simple word problems."],
            exam:["Write three solutions of 2x + y = 6.","Draw graph of x + 2y = 8.","Why infinite solutions?"],
            finals:["Graph + reasoning + application."]
          }
        },
        US:{
          COMMON_CORE:{
            learning:[
              "Linear equations model constant rate relationships.",
              "Tables, graphs, and equations represent the same relationship.",
              "A line on a graph shows all solutions."
            ],
            easy:["A line represents infinite solutions."],
            hard:["Compare two linear models."],
            exam:["Graph from a table.","Interpret slope & intercept (intro)."],
            finals:["Short modeling set."]
          }
        }
      },
      quizPool:[
        {q:"Graph of a linear equation in two variables is:", options:["Circle","Parabola","Straight line","Hyperbola"], correct:2},
        {q:"Number of solutions of 2x + y = 6:", options:["1","2","Infinite","0"], correct:2}
      ]
    },

    {
      id:"french-revolution",
      title:"The French Revolution",
      subject:"SST",
      strand:"History",
      grades:[9],
      tags:["Estates","1789","Rights"],
      visuals:{ mermaid:`
        graph TD
        A[French Society] --> B[First Estate: Clergy]
        A --> C[Second Estate: Nobility]
        A --> D[Third Estate]
        D --> E[Taxes + poverty]
        E --> F[1789 Revolution]
        F --> G[Rights of Man]
      `},
      content:{
        INDIA:{
          CBSE:{
            learning:[
              "France had a three-estate system with unequal privileges.",
              "The Third Estate paid most taxes and had least power.",
              "Economic crisis and Enlightenment ideas fueled unrest.",
              "1789 began major political change in France.",
              "Revolution spread ideas of liberty and equality."
            ],
            easy:["Three estates system was unfair.","Third Estate suffered most."],
            hard:["Link causes to social, political, economic factors.","Evaluate impact on democracy."],
            exam:["Describe the three estates.","State two causes.","What was Declaration of Rights?"],
            finals:["5-mark cause-impact answer."]
          }
        },
        US:{
          US_HISTORY:{
            learning:[
              "The French Revolution reshaped ideas about rights and citizenship.",
              "It influenced democratic movements globally."
            ],
            easy:["Unfair society led to revolt."],
            hard:["Compare themes with other revolutions."],
            exam:["Explain causes and outcomes."],
            finals:["Short comparative response."]
          }
        }
      },
      quizPool:[
        {q:"Which estate paid most taxes?", options:["First","Second","Third","None"], correct:2}
      ]
    }
  ];

  const SYSTEMS = {
    INDIA:{ label:"India", systems:["CBSE","ICSE"] },
    US:{ label:"United States", systems:["COMMON_CORE","NGSS","US_HISTORY"] }
  };

  const MODE_KEYS = {
    EASY:"easy",
    HARD:"hard",
    LEARNING:"learning",
    EXAM:"exam",
    FINALS:"finals"
  };

  /* ========= STATE ========= */
  let state = {
    step:"setup",
    grade:9,
    region:"INDIA",
    system:"CBSE",
    subject:"ALL",
    mode:"LEARNING",
    search:"",
    activeTopicId:null,
    tab:"CONTENT",
    timed:{
      running:false,
      remaining:0,
      questions:[],
      answers:{}
    }
  };

  /* ========= HELPERS ========= */
  const $ = (id) => document.getElementById(id);

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setBadge(){
    const badge = $("badge");
    badge.textContent = `${SYSTEMS[state.region].label} • ${state.system.replace("_"," ")} • Class ${state.grade}`;
    badge.className = "chip chip-active";
    badge.classList.remove("hidden");
  }

  function getTopicsFiltered(){
    const q = state.search.trim().toLowerCase();
    return TOPIC_LIBRARY
      .filter(t=>t.grades.includes(state.grade))
      .filter(t=>state.subject==="ALL" ? true : t.subject===state.subject)
      .filter(t=>{
        if(!q) return true;
        const hay = `${t.title} ${(t.tags||[]).join(" ")} ${t.strand||""}`.toLowerCase();
        return hay.includes(q);
      })
      .sort((a,b)=>a.subject.localeCompare(b.subject)||a.title.localeCompare(b.title));
  }

  function resolveBlock(topic){
    const modeKey = MODE_KEYS[state.mode];
    const regionBlock = topic.content?.[state.region];
    if(!regionBlock) return null;
    const sys = regionBlock?.[state.system];
    return sys?.[modeKey] || sys?.learning || null;
  }

  function resolveExamQs(topic){
    const regionBlock = topic.content?.[state.region];
    const sys = regionBlock?.[state.system];
    return sys?.exam || [];
  }

  function resolveFinalsQs(topic){
    const regionBlock = topic.content?.[state.region];
    const sys = regionBlock?.[state.system];
    return sys?.finals || [];
  }

  /* ========= ANIMATION HOOK ========= */
  function mount(html){
    const app = $("app");
    app.innerHTML = `<div class="page-enter">${html}</div>`;
  }

  /* ========= RENDER: SETUP (front page) ========= */
  function renderSetup(){
    const html = `
      <section class="grid lg:grid-cols-2 gap-6 items-stretch">
        <!-- LEFT: HERO -->
        <div class="glass p-8 md:p-10 relative overflow-hidden">
          <div class="absolute -top-24 -left-24 w-64 h-64 rounded-full bg-emerald-400/10 blur-3xl"></div>
          <div class="absolute -bottom-24 -right-24 w-72 h-72 rounded-full bg-blue-500/10 blur-3xl"></div>

          <div class="flex items-center gap-2 text-[10px] tracking-[0.3em] uppercase text-slate-400 font-bold">
            <span class="chip">Adaptive learning</span>
            <span class="chip">Offline demo</span>
            <span class="chip">9-10</span>
          </div>

          <h1 class="text-4xl md:text-5xl font-black mt-5 leading-[1.05]">
            Study faster. <br/>
            Understand deeper. <br/>
            <span class="grad-text">No wasted revision.</span>
          </h1>

          <p class="text-slate-300/90 mt-4 text-base md:text-lg">
            Pick your class and curriculum. EduMorph adjusts explanation style, difficulty,
            and exam prompts in one clean workspace.
          </p>

          <div class="mt-8 grid sm:grid-cols-3 gap-3">
            ${featureCard("Modes that matter","Easy → Learning → Hard → Exam → Finals")}
            ${featureCard("Clean visuals","Concept maps for faster memory")}
            ${featureCard("India + US","CBSE/ICSE + Common Core/NGSS")}
          </div>

          <div class="mt-8 flex flex-wrap gap-3">
            <button class="btn btn-primary px-6" onclick="startApp()">
              Start
            </button>
            <button class="btn btn-ghost px-6" onclick="previewLibrary()">
              Preview topics
            </button>
          </div>
        </div>

        <!-- RIGHT: SETUP FLOW -->
        <div class="glass p-8 md:p-10">
          <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold">Quick setup</div>
          <div class="text-2xl font-extrabold mt-2">Choose your track</div>

          <!-- STEP 1 -->
          <div class="glass-soft p-5 mt-6">
            <div class="flex items-center justify-between">
              <div class="text-sm font-extrabold">Class</div>
              <div class="text-[10px] text-slate-400 tracking-widest uppercase">Step 1</div>
            </div>
            <div class="mt-3 flex gap-2">
              ${[9,10].map(g=>`
                <button class="chip ${state.grade===g?'chip-active':''}" onclick="setGrade(${g})">Class ${g}</button>
              `).join("")}
            </div>
          </div>

          <!-- STEP 2 -->
          <div class="glass-soft p-5 mt-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-extrabold">Region</div>
              <div class="text-[10px] text-slate-400 tracking-widest uppercase">Step 2</div>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              ${Object.keys(SYSTEMS).map(r=>`
                <button class="chip ${state.region===r?'chip-active':''}" onclick="setRegion('${r}')">
                  ${SYSTEMS[r].label}
                </button>
              `).join("")}
            </div>
          </div>

          <!-- STEP 3 -->
          <div class="glass-soft p-5 mt-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-extrabold">Curriculum</div>
              <div class="text-[10px] text-slate-400 tracking-widest uppercase">Step 3</div>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
              ${SYSTEMS[state.region].systems.map(s=>`
                <button class="chip ${state.system===s?'chip-active':''}" onclick="setSystem('${s}')">
                  ${s.replace("_"," ")}
                </button>
              `).join("")}
            </div>
          </div>

          <div class="mt-6">
            <button class="btn btn-primary w-full" onclick="startApp()">
              Enter Workspace →
            </button>
            <div class="text-[11px] text-slate-500 mt-3">
              This is a polished offline demo. You can expand the topic library anytime.
            </div>
          </div>
        </div>
      </section>
    `;
    mount(html);
  }

  function featureCard(title, desc){
    return `
      <div class="glass-soft p-4">
        <div class="text-sm font-extrabold">${title}</div>
        <div class="text-xs text-slate-400 mt-1">${desc}</div>
      </div>
    `;
  }

  function previewLibrary(){
    state.step = "dashboard";
    setBadge();
    render();
  }

  /* ========= DASHBOARD ========= */
  function renderDashboard(){
    const topics = getTopicsFiltered();
    const active = state.activeTopicId
      ? TOPIC_LIBRARY.find(t=>t.id===state.activeTopicId)
      : (topics[0] || null);

    if(active && !state.activeTopicId) state.activeTopicId = active.id;

    const html = `
      <section class="grid lg:grid-cols-12 gap-5">
        <!-- LIBRARY -->
        <aside class="lg:col-span-4">
          <div class="glass p-5">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-[10px] tracking-[0.25em] uppercase text-slate-400 font-bold">Topic library</div>
                <div class="text-lg font-extrabold mt-1">Pick & Morph</div>
              </div>
              <button class="btn btn-ghost text-xs px-3 py-2" onclick="resetFilters()">Reset</button>
            </div>

            <div class="mt-4">
              <input class="input"
                     id="searchBox"
                     value="${escapeHtml(state.search)}"
                     placeholder="Search: Quadratic • Tissues • French Revolution"
                     oninput="updateSearch(this.value)"/>
            </div>

            <div class="mt-3 flex flex-wrap gap-2">
              ${["ALL","MATH","SCIENCE","SST"].map(s=>`
                <button class="chip ${state.subject===s?'chip-active':''}" onclick="setSubject('${s}')">${s}</button>
              `).join("")}
            </div>

            <div class="mt-4 max-h-[58vh] overflow-auto pr-1">
              ${topics.length ? topics.map(t=>topicCard(t)).join("") : `
                <div class="glass-soft p-4 text-sm text-slate-400">
                  No results. Try a different keyword.
                </div>
              `}
            </div>
          </div>
        </aside>

        <!-- WORKSPACE -->
        <section class="lg:col-span-8">
          <div class="glass p-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
              <div>
                <div class="text-[10px] tracking-[0.25em] uppercase text-slate-400 font-bold">Workspace</div>
                <div class="text-2xl font-black mt-1">${active ? active.title : "Select a topic"}</div>
                <div class="text-sm text-slate-400 mt-1">
                  ${active ? `${active.subject} • ${active.strand || ""} • Class ${state.grade}` : ""}
                </div>
              </div>

              <div class="flex flex-wrap gap-2">
                ${["EASY","LEARNING","HARD","EXAM","FINALS"].map(m=>`
                  <button class="mode ${state.mode===m?'mode-active':''}" onclick="setMode('${m}')">${m}</button>
                `).join("")}
              </div>
            </div>

            <div class="mt-4 flex flex-wrap gap-2">
              ${["CONTENT","VISUAL","PRACTICE","QUIZ"].map(t=>`
                <button class="tab ${state.tab===t?'tab-active':''}" onclick="setTab('${t}')">${t}</button>
              `).join("")}
            </div>

            <div class="mt-6">
              ${renderActivePanel(active)}
            </div>
          </div>
        </section>
      </section>
    `;
    mount(html);

    if(state.tab==="VISUAL" && active?.visuals?.mermaid){
      try{ mermaid.init(undefined, document.querySelectorAll(".mermaid")); }catch(e){}
    }
  }

  function topicCard(t){
    const active = t.id===state.activeTopicId;
    return `
      <button onclick="openTopic('${t.id}')"
              class="w-full text-left p-4 mb-2 glass-soft ${active?'glow-ring':''}"
              style="${active ? 'border-color: rgba(96,165,250,0.45); background: rgba(96,165,250,0.08);' : ''}">
        <div class="flex items-center justify-between gap-2">
          <div class="font-extrabold">${t.title}</div>
          <span class="chip">${t.subject}</span>
        </div>
        <div class="text-xs text-slate-400 mt-1">${t.strand || ""}</div>
        <div class="text-[10px] text-slate-500 mt-1">${(t.tags||[]).slice(0,4).join(" • ")}</div>
      </button>
    `;
  }

  /* ========= PANELS ========= */
  function renderActivePanel(topic){
    if(!topic){
      return `<div class="glass-soft p-5 text-slate-400">Select a topic from the left.</div>`;
    }

    if(state.tab==="CONTENT"){
      const block = resolveBlock(topic);
      const examQs = resolveExamQs(topic);
      const finalsQs = resolveFinalsQs(topic);

      return `
        <div class="glass-soft p-6 pop">
          <div class="flex flex-wrap items-center gap-2">
            <span class="chip chip-active">${SYSTEMS[state.region].label}</span>
            <span class="chip">${state.system.replace("_"," ")}</span>
            <span class="chip">${state.mode}</span>
          </div>

          <div class="mt-4 space-y-2 text-[17px] leading-relaxed">
            ${Array.isArray(block) ? block.map(x=>`<div>• ${escapeHtml(x)}</div>`).join("") : `
              <div class="text-slate-400">This mode isn’t filled for this track yet. Expand the library to add it.</div>
            `}
          </div>

          ${state.mode==="EXAM" && examQs.length ? `
            <div class="mt-6">
              <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold mb-2">Exam prompts</div>
              <div class="space-y-2">
                ${examQs.map(q=>`<div class="glass-soft p-3 text-sm">• ${escapeHtml(q)}</div>`).join("")}
              </div>
            </div>
          ` : ""}

          ${state.mode==="FINALS" && finalsQs.length ? `
            <div class="mt-6">
              <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold mb-2">Finals mix</div>
              <div class="space-y-2">
                ${finalsQs.map(q=>`<div class="glass-soft p-3 text-sm">• ${escapeHtml(q)}</div>`).join("")}
              </div>
            </div>
          ` : ""}
        </div>
      `;
    }

    if(state.tab==="VISUAL"){
      const m = topic.visuals?.mermaid;
      return `
        <div class="glass-soft p-6 pop">
          <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold">Concept map</div>
          <div class="mt-3 diagram-wrap">
            ${m ? `<div class="mermaid">${m}</div>` : `<div class="text-slate-400">No diagram added yet.</div>`}
          </div>
          <div class="text-[11px] text-slate-500 mt-3">
            This uses Mermaid. Any new topic with a Mermaid block will render automatically.
          </div>
        </div>
      `;
    }

    if(state.tab==="PRACTICE"){
      const pool = [
        ...(topic.quizPool||[]).map(x=>x.q),
        ...resolveExamQs(topic),
        ...resolveFinalsQs(topic)
      ].slice(0, 14);

      return `
        <div class="glass-soft p-6 pop">
          <div class="flex items-center justify-between">
            <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold">Practice set</div>
            <span class="chip">${state.mode}</span>
          </div>
          <div class="mt-4 space-y-2">
            ${pool.length ? pool.map((q,i)=>`
              <div class="glass-soft p-3 text-sm">
                <span class="text-slate-500">${i+1}.</span> ${escapeHtml(q)}
              </div>
            `).join("") : `<div class="text-slate-400">Practice bank will grow as you add more topics.</div>`}
          </div>
        </div>
      `;
    }

    if(state.tab==="QUIZ"){
      return renderQuizPanel(topic);
    }

    return "";
  }

  /* ========= QUIZ ========= */
  function pickRandom(arr,n){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a.slice(0,n);
  }

  function renderQuizPanel(topic){
    const pool = (topic.quizPool||[]);
    const micro = pickRandom(pool, Math.min(3, pool.length));

    const timedRunning = state.timed.running && state.timed.questions.length;

    return `
      <div class="grid md:grid-cols-2 gap-4 pop">
        <!-- MICRO -->
        <div class="glass-soft p-6">
          <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold">Micro-Quiz</div>
          <div class="text-sm text-slate-400 mt-1">Quick accuracy check</div>

          <div class="mt-4 space-y-3">
            ${micro.map((qObj, idx)=>`
              <div class="glass-soft p-3">
                <div class="font-bold text-sm">${escapeHtml(qObj.q)}</div>
                <div class="mt-2 space-y-1">
                  ${qObj.options.map((op,i)=>`
                    <label class="flex items-center gap-2 text-sm">
                      <input type="radio" name="micro_${idx}" value="${i}">
                      <span>${escapeHtml(op)}</span>
                    </label>
                  `).join("")}
                </div>
              </div>
            `).join("")}
          </div>

          <button class="btn btn-primary w-full mt-4"
            onclick="checkMicroQuiz(${JSON.stringify(micro).replaceAll('"','&quot;')})">
            Check Score
          </button>
          <div id="microScore" class="mt-3 text-sm"></div>
        </div>

        <!-- TIMED -->
        <div class="glass-soft p-6">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs tracking-[0.25em] uppercase text-slate-400 font-bold">2-Minute Blitz</div>
              <div class="text-sm text-slate-400 mt-1">Speed + accuracy</div>
            </div>
            <span class="chip">${state.mode}</span>
          </div>

          ${timedRunning ? renderTimedRunning() : `
            <div class="mt-4 glass-soft p-4 text-sm text-slate-300">
              5 fast MCQs. Auto-score when time ends.
            </div>
            <button class="btn btn-ghost w-full mt-4"
              onclick="startTimedQuiz('${topic.id}')">
              Start 2-Minute Quiz
            </button>
          `}

          <div id="timedScoreBox" class="mt-3 text-sm"></div>
        </div>
      </div>
    `;
  }

  function checkMicroQuiz(microArr){
    let score=0;
    microArr.forEach((qObj,idx)=>{
      const sel=document.querySelector(`input[name="micro_${idx}"]:checked`);
      if(sel && Number(sel.value)===qObj.correct) score++;
    });
    const pct=Math.round((score/microArr.length)*100);
    const msg = pct>=80 ? "Strong." : pct>=50 ? "Good. Revise once." : "Revisit basics.";
    $("microScore").innerHTML = `
      <div class="glass-soft p-3">
        <span class="font-extrabold">${score}/${microArr.length}</span>
        <span class="text-slate-400 ml-1">(${pct}%)</span>
        <span class="ml-2">${msg}</span>
      </div>
    `;
  }

  /* Timed quiz engine */
  let timerHandle=null;

  function startTimedQuiz(topicId){
    const topic = TOPIC_LIBRARY.find(t=>t.id===topicId);
    const pool = (topic.quizPool||[]);
    const qs = pickRandom(pool, Math.min(5, pool.length));

    state.timed.running=true;
    state.timed.remaining=120;
    state.timed.questions=qs;
    state.timed.answers={};

    render();

    runTimer();
  }

  function runTimer(){
    if(timerHandle) clearInterval(timerHandle);
    timerHandle=setInterval(()=>{
      if(!state.timed.running){
        clearInterval(timerHandle); timerHandle=null; return;
      }
      state.timed.remaining--;
      const d = document.getElementById("timerDisplay");
      if(d) d.textContent = formatTime(state.timed.remaining);
      if(state.timed.remaining<=0) finishTimedQuiz();
    },1000);
  }

  function recordTimedAnswer(qIndex,optIndex){
    state.timed.answers[qIndex]=optIndex;
  }

  function finishTimedQuizEarly(){ finishTimedQuiz(); }

  function finishTimedQuiz(){
    const qs=state.timed.questions;
    let score=0;
    qs.forEach((qObj,idx)=>{
      const ans=state.timed.answers[idx];
      if(ans!==undefined && ans===qObj.correct) score++;
    });

    state.timed.running=false;
    const pct=Math.round((score/qs.length)*100);
    const msg = pct>=80 ? "Finals pace." : pct>=50 ? "Good speed." : "Slow down, learn first.";

    render();

    setTimeout(()=>{
      const box = $("timedScoreBox");
      if(box){
        box.innerHTML = `
          <div class="glass-soft p-3">
            <span class="font-extrabold">Timed Score:</span>
            <span class="ml-1 font-extrabold text-emerald-300">${score}/${qs.length}</span>
            <span class="text-slate-400 ml-1">(${pct}%)</span>
            <span class="ml-2">${msg}</span>
          </div>
        `;
      }
    },0);
  }

  function renderTimedRunning(){
    const qs = state.timed.questions;
    return `
      <div class="mt-4">
        <div class="glass-soft p-3 flex items-center justify-between">
          <div class="text-sm font-extrabold">Time left</div>
          <div id="timerDisplay" class="text-lg font-black text-emerald-300">${formatTime(state.timed.remaining)}</div>
        </div>

        <div class="mt-3 max-h-[320px] overflow-auto pr-1 space-y-2">
          ${qs.map((qObj,idx)=>`
            <div class="glass-soft p-3">
              <div class="font-bold text-sm">${idx+1}. ${escapeHtml(qObj.q)}</div>
              <div class="mt-2 space-y-1">
                ${qObj.options.map((op,i)=>`
                  <label class="flex items-center gap-2 text-sm">
                    <input type="radio" name="timed_${idx}" value="${i}"
                      onchange="recordTimedAnswer(${idx},${i})"
                      ${state.timed.answers[idx]===i ? "checked" : ""}>
                    <span>${escapeHtml(op)}</span>
                  </label>
                `).join("")}
              </div>
            </div>
          `).join("")}
        </div>

        <button class="btn btn-ghost w-full mt-4" onclick="finishTimedQuizEarly()">
          Finish & Score
        </button>
      </div>
    `;
  }

  function formatTime(s){
    const m=Math.floor(Math.max(0,s)/60);
    const r=Math.max(0,s)%60;
    return `${String(m).padStart(2,"0")}:${String(r).padStart(2,"0")}`;
  }

  /* ========= ACTIONS ========= */
  function setGrade(g){ state.grade=g; state.activeTopicId=null; render(); }
  function setRegion(r){ state.region=r; state.system=SYSTEMS[r].systems[0]; state.activeTopicId=null; render(); }
  function setSystem(s){ state.system=s; state.activeTopicId=null; render(); }
  function startApp(){ state.step="dashboard"; setBadge(); render(); }
  function setSubject(s){ state.subject=s; state.activeTopicId=null; render(); }
  function setMode(m){ state.mode=m; render(); }
  function setTab(t){ state.tab=t; state.timed.running=false; render(); }
  function updateSearch(v){ state.search=v; state.activeTopicId=null; render(); }
  function openTopic(id){ state.activeTopicId=id; state.tab="CONTENT"; state.timed.running=false; render(); }
  function resetFilters(){ state.subject="ALL"; state.search=""; state.activeTopicId=null; render(); }

  function resetApp(){
    state.step="setup";
    state.grade=9;
    state.region="INDIA";
    state.system="CBSE";
    state.subject="ALL";
    state.mode="LEARNING";
    state.search="";
    state.activeTopicId=null;
    state.tab="CONTENT";
    state.timed.running=false;
    $("badge").classList.add("hidden");
    render();
  }

  /* ========= RENDER ROOT ========= */
  function render(){
    if(state.step==="setup") renderSetup();
    else renderDashboard();
  }

  render();
</script>
</body>
</html>
